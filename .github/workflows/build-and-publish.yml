name: Build and Publish Docker Images

on:
  workflow_dispatch:
    inputs:
      dockerfile_path:
        description: 'Path to Dockerfile (e.g., php/8.4/octane-ready) - leave empty to build all'
        required: false
        type: string

env:
  REGISTRY: ghcr.io

jobs:
  discover-dockerfiles:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Discover Dockerfiles and targets
        id: set-matrix
        run: |
          # Find all Dockerfiles
          if [ -n "${{ inputs.dockerfile_path }}" ]; then
            dockerfiles="${{ inputs.dockerfile_path }}/Dockerfile"
          else
            dockerfiles=$(find . -name "Dockerfile" -type f | sed 's|^\./||')
          fi

          # Create matrix with dockerfile paths and their targets
          matrix_include="["
          first=true

          for dockerfile in $dockerfiles; do
            if [ ! -f "$dockerfile" ]; then
              echo "Warning: $dockerfile not found, skipping..."
              continue
            fi

            # Extract directory path (remove /Dockerfile)
            dir_path=$(dirname "$dockerfile")

            # Extract base image name from directory structure
            # e.g., php/8.4/octane-ready -> php:8.4-octane-ready
            IFS='/' read -ra PARTS <<< "$dir_path"
            if [ ${#PARTS[@]} -eq 0 ]; then
              continue
            fi

            # First part is the image name (e.g., php)
            image_name="${PARTS[0]}"

            # Join remaining parts with dashes for the tag base
            tag_base=""
            for i in "${!PARTS[@]}"; do
              if [ $i -gt 0 ]; then
                if [ -n "$tag_base" ]; then
                  tag_base="${tag_base}-${PARTS[$i]}"
                else
                  tag_base="${PARTS[$i]}"
                fi
              fi
            done

            # Extract build targets from Dockerfile
            targets=$(grep -i "^FROM .* AS " "$dockerfile" | sed -E 's/^FROM .* AS ([^ ]+).*$/\1/' || echo "")

            if [ -z "$targets" ]; then
              # No targets found, build default image
              if [ "$first" = true ]; then
                first=false
              else
                matrix_include="${matrix_include},"
              fi

              matrix_include="${matrix_include}{\"dockerfile\":\"$dockerfile\",\"image\":\"$image_name\",\"tag\":\"$tag_base\",\"target\":\"\",\"context\":\"$dir_path\"}"
            else
              # Build each target
              while IFS= read -r target; do
                if [ "$first" = true ]; then
                  first=false
                else
                  matrix_include="${matrix_include},"
                fi

                # Create tag with target suffix
                full_tag="${tag_base}-${target}"

                matrix_include="${matrix_include}{\"dockerfile\":\"$dockerfile\",\"image\":\"$image_name\",\"tag\":\"$full_tag\",\"target\":\"$target\",\"context\":\"$dir_path\"}"
              done <<< "$targets"
            fi
          done

          matrix_include="${matrix_include}]"
          matrix="{\"include\":$matrix_include}"

          echo "matrix=$matrix" >> $GITHUB_OUTPUT
          echo "Generated matrix:"
          echo "$matrix" | jq .

  build-and-push:
    needs: discover-dockerfiles
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.discover-dockerfiles.outputs.matrix) }}
      fail-fast: false
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.image }}
          tags: |
            type=raw,value=${{ matrix.tag }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context || '.' }}
          file: ${{ matrix.dockerfile }}
          target: ${{ matrix.target }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Image summary
        run: |
          echo "### Built and pushed image :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.image }}:${{ matrix.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Dockerfile**: \`${{ matrix.dockerfile }}\`" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ matrix.target }}" ]; then
            echo "- **Target**: \`${{ matrix.target }}\`" >> $GITHUB_STEP_SUMMARY
          fi
